name: Test Automation Pipeline

# ============================================================================
# GOLDEN PIPELINE: Strategic 2-Tier Testing Architecture
# ============================================================================
# Tier 1: CI Smoke Tests (PR Gate) - Fast feedback for pull requests
# Tier 2: Nightly Regression (Full Coverage) - Comprehensive multi-browser testing
# ============================================================================

on:
  # Trigger 1: Pull requests (Tier 1 smoke tests)
  pull_request:
    branches: [ main, develop ]  # Added develop for shift-left validation
    paths:
      - 'features/**'
      - 'playwright.config.ts'
      - 'package.json'
      - 'tsconfig.json'
      - '.github/workflows/test-automation.yml'

  # Trigger 2: Push to main (Smoke tests verification)
  push:
    branches: [ main ] 
    paths:
      - 'features/**'
      - 'playwright.config.ts'

  # Trigger 3: Scheduled nightly regression (2 AM UTC)
  schedule:
    - cron: '0 2 * * *'

  # Trigger 4: Manual dispatch with options
  workflow_dispatch:
    inputs:
      test-scope:
        description: 'Test scope to run'
        required: true
        default: 'smoke'
        type: choice
        options:
          - smoke
          - regression
          - all
      browser:
        description: 'Browser selection (for manual runs)'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - chromium
          - firefox
          - webkit

# ============================================================================
# CONCURRENCY STRATEGY
# ============================================================================
# Cancel previous runs to prevent queue buildup
# Exception: Do not cancel nightly runs (full coverage should complete)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name != 'schedule' }}

# ============================================================================
# PERMISSIONS
# ============================================================================
permissions:
  contents: read
  checks: write
  pull-requests: write
  pages: write
  id-token: write

# ============================================================================
# JOBS
# ============================================================================

jobs:
  # ========================================================================
  # SETUP: Determine which test scope to run
  # ========================================================================
  setup:
    name: Setup Test Configuration
    runs-on: ubuntu-latest
    outputs:
      test-scope: ${{ steps.config.outputs.test-scope }}
      browsers: ${{ steps.config.outputs.browsers }}
      workers: ${{ steps.config.outputs.workers }}
      timeout: ${{ steps.config.outputs.timeout }}
    steps:
      - name: Determine Test Configuration
        id: config
        run: |
          # Default configuration based on trigger
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PR trigger: Fast smoke tests
            echo "test-scope=smoke" >> $GITHUB_OUTPUT
            echo "browsers=[\"chromium\"]" >> $GITHUB_OUTPUT
            echo "workers=4" >> $GITHUB_OUTPUT
            echo "timeout=15" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            # Scheduled: Full nightly regression
            echo "test-scope=regression" >> $GITHUB_OUTPUT
            echo "browsers=[\"chromium\",\"firefox\",\"webkit\"]" >> $GITHUB_OUTPUT
            echo "workers=2" >> $GITHUB_OUTPUT
            echo "timeout=50" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            # Manual: User-selected configuration
            if [ "${{ github.event.inputs.test-scope }}" = "all" ]; then
              echo "test-scope=regression" >> $GITHUB_OUTPUT
            else
              echo "test-scope=${{ github.event.inputs.test-scope }}" >> $GITHUB_OUTPUT
            fi
            
            if [ "${{ github.event.inputs.browser }}" != "all" ]; then
              echo "browsers=[\"${{ github.event.inputs.browser }}\"]" >> $GITHUB_OUTPUT
            else
              echo "browsers=[\"chromium\",\"firefox\",\"webkit\"]" >> $GITHUB_OUTPUT
            fi
            echo "workers=2" >> $GITHUB_OUTPUT
            echo "timeout=50" >> $GITHUB_OUTPUT
          else
            # Default: Push to main - smoke tests
            echo "test-scope=smoke" >> $GITHUB_OUTPUT
            echo "browsers=[\"chromium\"]" >> $GITHUB_OUTPUT
            echo "workers=4" >> $GITHUB_OUTPUT
            echo "timeout=15" >> $GITHUB_OUTPUT
          fi

  # ========================================================================
  # TESTS: Run Playwright tests with appropriate scope and browsers
  # ========================================================================
  tests:
    name: Tests - ${{ matrix.browser }}
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: ${{ fromJson(needs.setup.outputs.timeout) }}
    continue-on-error: false

    strategy:
      fail-fast: false
      matrix:
        browser: ${{ fromJson(needs.setup.outputs.browsers) }}

    steps:
      # 1. Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Node.js with npm cache
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      # 3. Cache Playwright browser binaries
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-${{ matrix.browser }}-${{ hashFiles('package-lock.json') }}

      # 4. Install dependencies
      - name: Install Dependencies
        run: npm ci --omit=optional
        timeout-minutes: 5

      # 5. Install Playwright browsers (specific to matrix browser)
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps ${{ matrix.browser }}
        timeout-minutes: 10

      # 6. Run tests with appropriate grep pattern and worker count
      # Uses 3-layer architecture: API (foundation), E2E-UI (workflows), Accessibility (compliance)
      - name: Run Tests (${{ needs.setup.outputs.test-scope }} - ${{ matrix.browser }})
        env:
          PLAYWRIGHT_TEST_TIMEOUT: 90000
          PLAYWRIGHT_EXPECT_TIMEOUT: 15000
        run: |
          if [ "${{ needs.setup.outputs.test-scope }}" = "smoke" ]; then
            echo "Running smoke tests: API + E2E-UI + Critical A11y..."
            npx playwright test features/tests/ --grep "@smoke|(@a11y.*(homepage|Homepage))" --project=${{ matrix.browser }} --workers=${{ needs.setup.outputs.workers }} --reporter=html,json,junit
          else
            echo "Running full regression suite across all 3 layers..."
            npx playwright test features/tests/ --grep @regression --project=${{ matrix.browser }} --workers=${{ needs.setup.outputs.workers }} --reporter=html,json,junit
          fi
        timeout-minutes: ${{ fromJson(needs.setup.outputs.timeout) }}
        continue-on-error: ${{ github.event_name == 'schedule' }}

      # 7. Upload HTML Report
      - name: Upload Playwright Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ matrix.browser }}-${{ github.run_id }}
          path: playwright-report/
          retention-days: ${{ needs.setup.outputs.test-scope == 'smoke' && '7' || '14' }}
          if-no-files-found: ignore

      # 8. Upload JSON Results
      - name: Upload Test Results (JSON)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.browser }}-json
          path: test-results/
          retention-days: ${{ needs.setup.outputs.test-scope == 'smoke' && '7' || '14' }}
          if-no-files-found: ignore

      # 9. Upload JUnit Report for GitHub Checks
      - name: Upload JUnit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-report-${{ matrix.browser }}
          path: junit-results/
          retention-days: ${{ needs.setup.outputs.test-scope == 'smoke' && '7' || '14' }}
          if-no-files-found: ignore

      # 10. Publish Test Results to PR/Checks
      - name: Publish Test Results
        if: always()
        uses: EnricoMi/publish-unit-test-result-action@v2
        with:
          files: junit-results/results.xml
          check_name: 'Tests - ${{ needs.setup.outputs.test-scope }} - ${{ matrix.browser }}'
          comment_mode: always
          compare_to_earlier_commit: true

  # ========================================================================
  # API TESTS: Run Playwright API smoke tests (api project)
  # ========================================================================
  api-tests:
    name: API Smoke Tests
    runs-on: ubuntu-latest
    needs: setup
    timeout-minutes: 10
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'


      - name: Install Dependencies
        run: npm ci --omit=optional

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium

      - name: Run API Smoke Tests
        run: npx playwright test features/tests/api/ --grep "@smoke" --project=api --reporter=html,json,junit
  # ========================================================================
  # A11Y AUDIT: Accessibility compliance (WCAG 2.1 AA)
  # ========================================================================
  accessibility-audit:
    name: Accessibility Audit (WCAG 2.1 AA)
    runs-on: ubuntu-latest
    # Run A11y tests during nightly, PRs (smoke), or when explicitly requested
    if: |
      github.event_name == 'schedule' ||
      github.event_name == 'pull_request' ||
      (github.event_name == 'workflow_dispatch' && 
       (github.event.inputs.test-scope == 'all' || github.event.inputs.test-scope == 'regression'))
    timeout-minutes: 20
    continue-on-error: true

    steps:
      # 1. Checkout code
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18.x'
          cache: 'npm'

      # 3. Cache Playwright browsers
      - name: Cache Playwright Browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: playwright-${{ runner.os }}-chromium-${{ hashFiles('package-lock.json') }}

      # 4. Install dependencies
      - name: Install Dependencies
        run: npm ci --omit=optional
        timeout-minutes: 5

      # 5. Install Playwright browsers (chromium only for a11y)
      - name: Install Playwright Browsers
        run: npx playwright install --with-deps chromium
        timeout-minutes: 5

      # 6. Run accessibility audit (Layer 3: WCAG 2.1 AA compliance)
      - name: Run Accessibility Audit
        run: |
          echo "Running Layer 3: Accessibility audit (WCAG 2.1 AA)..."
          npx playwright test features/tests/accessibility/ --grep @a11y --project=chromium --reporter=html,json
        timeout-minutes: 10

      # 7. Upload A11y Report
      - name: Upload A11y Audit Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-audit-report
          path: |
            playwright-report/
            test-results/
          retention-days: 30
          if-no-files-found: ignore

      # 8. Upload A11y Violations (testInfo.attach() output)
      - name: Upload A11y Violations Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: a11y-violations-${{ github.run_id }}
          path: |
            playwright-report/data/*.json
            test-results/**/*violations*.json
          retention-days: 30
          if-no-files-found: ignore

      # 9. Analyze A11y Compliance
      - name: Analyze Accessibility Compliance
        if: always()
        run: |
          echo "## üîç Accessibility Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ WCAG 2.1 AA audit completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Count violations from test results (soft assertions pattern)
          if [ -f "test-results/results.json" ]; then
            violation_count=$(jq '[.suites[].specs[].tests[].results[].attachments[]? | select(.name | contains("accessibility-violations"))] | length' test-results/results.json 2>/dev/null || echo "0")
            echo "**Violations Logged:** $violation_count (non-blocking)" >> $GITHUB_STEP_SUMMARY
            echo "**Pattern:** Soft assertions - tests pass, violations logged for audit trail" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "See 'a11y-audit-report' and 'a11y-violations' artifacts for detailed results." >> $GITHUB_STEP_SUMMARY

  # ========================================================================
  # RESULTS SUMMARY: Consolidate test results and notify
  # ========================================================================
  results-summary:
    name: Test Results Summary
    runs-on: ubuntu-latest
    needs: [setup, tests]
    if: always()
    timeout-minutes: 10

    steps:
      # 1. Download all test artifacts
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/
          pattern: |
            test-results-*
            junit-report-*
            playwright-report-*
            a11y-audit-report

      # 2. Generate comprehensive summary
      - name: Generate Test Summary
        run: |
          echo "## üß™ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scope:** ${{ needs.setup.outputs.test-scope }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "| Setting | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Test Scope | ${{ needs.setup.outputs.test-scope }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Workers | ${{ needs.setup.outputs.workers }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Timeout | ${{ needs.setup.outputs.timeout }} min |" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Parse test statistics from JSON results
          echo "### Test Statistics" >> $GITHUB_STEP_SUMMARY
          if [ -f "artifacts/test-results-chromium-json/results.json" ]; then
            total_tests=$(jq '[.suites[].specs[].tests[]] | length' artifacts/test-results-chromium-json/results.json 2>/dev/null || echo "N/A")
            passed_tests=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "passed")] | length' artifacts/test-results-chromium-json/results.json 2>/dev/null || echo "N/A")
            failed_tests=$(jq '[.suites[].specs[].tests[].results[] | select(.status == "failed")] | length' artifacts/test-results-chromium-json/results.json 2>/dev/null || echo "N/A")
            duration=$(jq '[.suites[].specs[].tests[].results[].duration] | add / 1000 | round' artifacts/test-results-chromium-json/results.json 2>/dev/null || echo "N/A")
            
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Tests | $total_tests |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚úÖ Passed | $passed_tests |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚ùå Failed | $failed_tests |" >> $GITHUB_STEP_SUMMARY
            echo "| ‚è±Ô∏è Duration | ${duration}s |" >> $GITHUB_STEP_SUMMARY
          else
            echo "Test statistics not available - check artifacts" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "- üìä HTML reports (browser-specific)" >> $GITHUB_STEP_SUMMARY
          echo "- üìã JSON results (programmatic parsing)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ôø A11y violations (30-day audit trail)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Timestamp:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

      # 3. PR Comment with Results (only for PR trigger)
      - name: Comment PR with Results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ needs.tests.result }}' === 'success' ? '‚úÖ PASS - Ready for merge' : '‚ùå FAIL - Review required';
            const runUrl = '${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}';
            
            const body = [
              '## üß™ Smoke Test Results',
              '',
              '**Status:** ' + status,
              '',
              '**Configuration:**',
              '- Test Scope: @smoke + Critical A11y (homepage)',
              '- Layers: API (5 tests) + E2E-UI + A11y',
              '- Browser: Chromium',
              '- Workers: 4 parallel',
              '- Duration: ~10 minutes',
              '',
              '**Test Coverage:**',
              '- ‚úÖ API endpoint validation',
              '- ‚úÖ Guest checkout (revenue path)',
              '- ‚úÖ Navigation & state persistence',
              '- ‚úÖ Homepage WCAG 2.1 AA scan',
              '',
              'üìä See artifacts for detailed HTML reports and test traces.',
              '',
              '_Run: [' + context.runId + '](' + runUrl + ')_'
            ].join('\n');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  # ========================================================================
  # DEPLOYMENT GATE: Block PR merge if smoke tests fail
  # ========================================================================
  deployment-gate:
    name: Deployment Gate
    runs-on: ubuntu-latest
    needs: tests
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Check PR Gate Status
        run: |
          if [ "${{ needs.tests.result }}" != "success" ]; then
            echo "‚ùå Smoke tests failed. PR merge blocked."
            exit 1
          else
            echo "‚úÖ Smoke tests passed. PR can be merged."
          fi

  # ========================================================================
  # DEPLOY REPORT: Publish test results to GitHub Pages
  # ========================================================================
  deploy-report:
    name: Deploy Report to GitHub Pages
    runs-on: ubuntu-latest
    needs: [setup, tests, results-summary]
    if: always() && (github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
    permissions:
      contents: read
      pages: write
      id-token: write
    
    steps:
      # 1. Download all test artifacts
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: ./artifacts

      # 2. Create merged report directory
      - name: Prepare Report Directory
        run: |
          mkdir -p gh-pages/data
          
          # Find and copy the first available Playwright report
          for browser in chromium firefox webkit; do
            report_dir="./artifacts/playwright-report-${browser}-${{ github.run_id }}"
            if [ -d "$report_dir" ]; then
              echo "Found report for $browser, copying..."
              cp -r "$report_dir"/* gh-pages/data/ || true
              break
            fi
          done
          
          # If no browser-specific report found, check for generic report
          if [ ! -f "gh-pages/data/index.html" ]; then
            echo "No browser reports found, creating fallback index..."
            mkdir -p gh-pages/data
          fi

      # 3. Create custom landing page
      - name: Create Landing Page
        run: |
          cat > gh-pages/index.html << 'EOFHTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Companies House QA Assessment - Test Report</title>
            <style>
              * { margin: 0; padding: 0; box-sizing: border-box; }
              body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                min-height: 100vh;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 20px;
              }
              .container {
                background: white;
                border-radius: 16px;
                box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                max-width: 900px;
                width: 100%;
                padding: 50px;
                animation: fadeIn 0.6s ease-out;
              }
              @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
              }
              h1 {
                color: #2d3748;
                margin-bottom: 12px;
                font-size: 2.8em;
                font-weight: 700;
              }
              .subtitle {
                color: #718096;
                margin-bottom: 35px;
                font-size: 1.2em;
                font-weight: 500;
              }
              .badges {
                margin: 25px 0 35px;
                display: flex;
                flex-wrap: wrap;
                gap: 12px;
              }
              .badge {
                display: inline-flex;
                align-items: center;
                padding: 8px 16px;
                border-radius: 6px;
                font-size: 0.9em;
                font-weight: 600;
                gap: 6px;
              }
              .badge-playwright { background: #2EAD33; color: white; }
              .badge-typescript { background: #007ACC; color: white; }
              .badge-wcag { background: #28a745; color: white; }
              .badge-roi { background: #3b82f6; color: white; }
              .meta {
                background: linear-gradient(to right, #f7fafc, #edf2f7);
                border-left: 4px solid #667eea;
                padding: 25px;
                margin-bottom: 35px;
                border-radius: 8px;
              }
              .meta-title {
                font-size: 1.1em;
                font-weight: 700;
                color: #2d3748;
                margin-bottom: 15px;
              }
              .meta-item {
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid #e2e8f0;
              }
              .meta-item:last-child { border-bottom: none; }
              .meta-label {
                font-weight: 600;
                color: #4a5568;
              }
              .meta-value {
                color: #718096;
                font-family: 'Courier New', monospace;
                font-size: 0.95em;
              }
              .buttons {
                display: flex;
                gap: 15px;
                flex-wrap: wrap;
              }
              .btn {
                display: inline-flex;
                align-items: center;
                gap: 8px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 16px 32px;
                border-radius: 10px;
                text-decoration: none;
                font-weight: 600;
                font-size: 1.05em;
                transition: all 0.3s ease;
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
              }
              .btn:hover {
                transform: translateY(-2px);
                box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
              }
              .btn-secondary {
                background: linear-gradient(135deg, #718096 0%, #4a5568 100%);
                box-shadow: 0 4px 15px rgba(113, 128, 150, 0.4);
              }
              .btn-secondary:hover {
                box-shadow: 0 6px 20px rgba(113, 128, 150, 0.6);
              }
              .footer {
                margin-top: 30px;
                padding-top: 25px;
                border-top: 2px solid #e2e8f0;
                text-align: center;
                color: #718096;
                font-size: 0.9em;
              }
              .footer a {
                color: #667eea;
                text-decoration: none;
                font-weight: 600;
              }
              .footer a:hover {
                text-decoration: underline;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>üé≠ Companies House QA Assessment</h1>
              <p class="subtitle">Strategic Test Automation Framework | Reference: 437782</p>
              
              <div class="badges">
                <span class="badge badge-playwright">üé≠ Playwright</span>
                <span class="badge badge-typescript">üíô TypeScript</span>
                <span class="badge badge-wcag">‚ôø WCAG 2.1 AA</span>
                <span class="badge badge-roi">üìà ROI: 62.5%</span>
              </div>
              
              <div class="meta">
                <div class="meta-title">üìä Latest Test Execution</div>
                <div class="meta-item">
                  <span class="meta-label">Last Run:</span>
                  <span class="meta-value" id="timestamp"></span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Branch:</span>
                  <span class="meta-value">GITHUB_REF_NAME</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Commit:</span>
                  <span class="meta-value">GITHUB_SHA_SHORT</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Test Scope:</span>
                  <span class="meta-value">TEST_SCOPE</span>
                </div>
                <div class="meta-item">
                  <span class="meta-label">Run ID:</span>
                  <span class="meta-value">#GITHUB_RUN_ID</span>
                </div>
              </div>
              
              <div class="buttons">
                <a href="./data/" class="btn">
                  üìä View Detailed Report ‚Üí
                </a>
                <a href="https://github.com/GITHUB_REPOSITORY" class="btn btn-secondary">
                  üìÅ View Repository ‚Üí
                </a>
              </div>
              
              <div class="footer">
                <p>Automated with ‚ù§Ô∏è by <a href="https://playwright.dev" target="_blank">Playwright</a></p>
                <p style="margin-top: 10px; font-size: 0.85em;">3-Pillar Architecture: Strategic Governance | Technical Excellence | GenAI Acceleration</p>
              </div>
            </div>
            
            <script>
              const now = new Date();
              const options = { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit',
                timeZoneName: 'short'
              };
              document.getElementById('timestamp').textContent = now.toLocaleString('en-GB', options);
            </script>
          </body>
          </html>
          EOFHTML
          
          # Replace placeholders with actual values
          sed -i "s|GITHUB_REF_NAME|${{ github.ref_name }}|g" gh-pages/index.html
          sed -i "s|GITHUB_SHA_SHORT|${GITHUB_SHA:0:7}|g" gh-pages/index.html
          sed -i "s|TEST_SCOPE|${{ needs.setup.outputs.test-scope }}|g" gh-pages/index.html
          sed -i "s|GITHUB_RUN_ID|${{ github.run_id }}|g" gh-pages/index.html
          sed -i "s|GITHUB_REPOSITORY|${{ github.repository }}|g" gh-pages/index.html

      # 4. Setup GitHub Pages
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # 5. Upload artifact for Pages
      - name: Upload Pages Artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: gh-pages

      # 6. Deploy to GitHub Pages
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

# ============================================================================
# STRATEGY SUMMARY
# ============================================================================
#
# TIER 1: CI SMOKE TESTS (PR Gate)
# ‚îú‚îÄ Trigger: Pull requests to main
# ‚îú‚îÄ Scope: @smoke tests (fast critical paths)
# ‚îú‚îÄ Folders: features/tests/api/, features/tests/e2e-ui/, features/tests/accessibility/
# ‚îú‚îÄ Browser: Chromium only
# ‚îú‚îÄ Workers: 4 (speed)
# ‚îú‚îÄ Duration: ~10 minutes
# ‚îú‚îÄ Artifact Retention: 7 days
# ‚îî‚îÄ Action: Block PR merge on failure
#
# TIER 2: NIGHTLY REGRESSION (Full Coverage)
# ‚îú‚îÄ Trigger: 2 AM UTC daily (cron)
# ‚îú‚îÄ Scope: @regression tests (all scenarios)
# ‚îú‚îÄ Layers: Layer 1 (API) ‚Üí Layer 2 (E2E-UI) ‚Üí Layer 3 (A11y Compliance)
# ‚îú‚îÄ Browsers: Chromium, Firefox, Webkit (matrix)
# ‚îú‚îÄ Workers: 2 (stability)
# ‚îú‚îÄ Duration: ~45 minutes
# ‚îú‚îÄ Artifact Retention: 14 days
# ‚îú‚îÄ A11y Audit: WCAG 2.1 AA (30-day retention)
# ‚îî‚îÄ Action: Informational; reports compliance
#
# QUALITY FEATURES:
# ‚úÖ 3-Layer Architecture: API (foundation) ‚Üí E2E-UI (workflows) ‚Üí A11y (compliance)
# ‚úÖ Concurrency: Smart cancellation (except nightly)
# ‚úÖ Caching: Browser + npm dependencies
# ‚úÖ Matrix: Dynamic browser selection (smoke: chromium, regression: all 3)
# ‚úÖ Reporting: HTML + JSON + JUnit + PR comments
# ‚úÖ A11y: Integrated WCAG 2.1 AA audit (Layer 3)
# ‚úÖ Manual Dispatch: User-selectable test scope
# ‚úÖ Resilience: Non-blocking A11y failures
# ‚úÖ Artifacts: Retention policies based on scope
# ‚úÖ Scalability: Supports growth from 12 tests ‚Üí 50+ scenarios
#
# ============================================================================
